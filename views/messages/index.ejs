<%- layout("layouts/boilerplate") %>

<div class="container-fluid">
    <%- include("../includes/breadcrumb") %>
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">Messages</h1>
                <% if (unreadCount > 0) { %>
                    <span class="badge bg-primary fs-6"><%= unreadCount %> unread</span>
                <% } %>
            </div>

            <% if (conversations.length === 0) { %>
                <div class="text-center py-5">
                    <i class="fas fa-envelope fa-3x text-muted mb-3"></i>
                    <h3 class="text-muted">No messages yet</h3>
                    <p class="text-muted">Start a conversation by contacting a host about their listing.</p>
                    <a href="/listings" class="btn btn-primary">Browse Listings</a>
                </div>
            <% } else { %>
                <div class="row">
                    <% conversations.forEach(conversation => { %>
                        <div class="col-12 mb-3">
                            <div class="card conversation-card <%= conversation.lastMessage && !conversation.lastMessage.isRead && conversation.lastMessage.sender !== currUser._id ? 'border-primary' : '' %>">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <div class="d-flex align-items-center mb-2">
                                                <% const otherParticipant = conversation.participants.find(p => !p._id.equals(currUser._id)); %>
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; font-size: 0.875rem; font-weight: 600;">
                                                    <%= otherParticipant.username.charAt(0).toUpperCase() %>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0"><%= otherParticipant.username %></h6>
                                                    <small class="text-muted">About: <%= conversation.listing.title %></small>
                                                </div>
                                            </div>
                                            <% if (conversation.lastMessage) { %>
                                                <p class="mb-1 text-truncate">
                                                    <strong><%= conversation.lastMessage.sender.equals(currUser._id) ? 'You' : conversation.lastMessage.sender.username %>:</strong>
                                                    <%= conversation.lastMessage.content %>
                                                </p>
                                            <% } else { %>
                                                <p class="mb-1 text-muted">No messages yet</p>
                                            <% } %>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <% if (conversation.lastMessage) { %>
                                                <small class="text-muted d-block">
                                                    <%= new Date(conversation.lastMessageAt).toLocaleDateString() %>
                                                </small>
                                            <% } %>
                                            <a href="/messages/<%= conversation._id %>" class="btn btn-outline-primary btn-sm">
                                                View Conversation
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } %>
        </div>
    </div>
</div>

<style>
.conversation-card {
    transition: all 0.2s ease;
    cursor: pointer;
}

.conversation-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.conversation-card.border-primary {
    border-width: 2px !important;
}
</style>